## 6. Local Ingress

### Load balancer  

Creating a meaningful local ingress configuration requires a few specific steps.  

*minikube loadbalancing*  

These local configuration and development examples assume you are using the minikube tunnel feature to simulate a loadbalancer that istio will use for the ingressgateway service. See the [all-in-one kubernetes setup guide](doc/kubernetes.md).  

Launch minikube [LoadBalancer](https://minikube.sigs.k8s.io/docs/tasks/loadbalancer/#using-minikube-tunnel) *in separate terminal window*  

```
$ minikube tunnel
```

What IP is used by the istio ingressgateway?  
```bash
$ kubectl get svc istio-ingressgateway -n istio-system
```

You will see something like:  
```bash
NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)                                                                      AGE
istio-ingressgateway   LoadBalancer   10.96.138.70   10.96.138.70   15021:32452/TCP,80:30496/TCP,443:31765/TCP,15012:31912/TCP,15443:32267/TCP   19m
```

The EXTERNAL-IP is the address to use when setting localhost DNS values.  

### Local host file entries 

The examples will use various URLs for UI or API, but in general, you will need a localhost entry on your computer for DNS resolution to work as expected.  

You can simply edit the `hostfile` on your local machine to include a specific domain:  

```bash
10.96.138.70  local.example.com
```

Adding the above entry would resolve local.example.com to the IP of the local istio-ingressgateway.  

[hostess](https://github.com/cbednarski/hostess) is a small utility that can make that kind of hostfile management easier on macos. Must run as `sudo` to edit the locahost file (as you would expect).    

### Local certificates for HTTPS

[`mkcert`](https://github.com/FiloSottile/mkcert) is used in these examples as a local Root CA. Be sure to review the README for this utility for securitiy concerns. tl;dr don't let cert or keys generated by mkcert leave your computer.  

First, Install the local CA in the system trust store:  

```bash
$ mkcert -install
```

To create certificates for local.example.com:  


```bash
$ mkcert -cert-file local.example.com.crt -key-file local.example.com.key local.example.com "*.local.example.com"
```

The certificates must be deployed as a secret to the istio-system namespace in order to be used by the ingressgateway:  

```bash
$ kubectl create -n istio-system secret tls local.example.com-credential --key=local.example.com.key --cert=local.example.com.crt
```

Each of the examples shows specific examples and how to validate the configuration.  
